<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora N&oacute;mina Completa (Con Novedades)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --info: #17a2b8;
            /* Colores de Estados */
            --day-bg: #fff3cd; --day-text: #856404;       /* Diurno */
            --night-bg: #d1ecf1; --night-text: #0c5460;   /* Nocturno */
            --rest-bg: #d4edda; --rest-text: #155724;     /* Descanso */
            --perm-bg: #e8daef; --perm-text: #6c3483;     /* Permiso (Morado) */
            --abs-bg: #fadbd8; --abs-text: #922b21;       /* Ausencia (Rojo) */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f7;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1250px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        }

        h1 { text-align: center; color: var(--primary); margin-bottom: 5px; }
        .badge-new { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.6em; vertical-align: middle; }
        p.subtitle { text-align: center; color: #666; margin-bottom: 30px; }

        .controls-panel {
            background: #eef2f6;
            padding: 25px;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
            border: 1px solid #dfe6e9;
        }

        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 700; font-size: 0.85em; color: var(--primary); margin-bottom: 6px; }
        .input-group input, .input-group select {
            padding: 12px; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 1em;
        }

        .btn-group { grid-column: 1 / -1; display: flex; gap: 10px; }
        button { flex: 1; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; color: white; }
        .btn-action { background-color: var(--primary); }
        .btn-action:hover { background-color: #34495e; }
        .btn-pdf { background-color: #c0392b; }
        .btn-pdf:hover { background-color: #a93226; }

        /* Calendario */
        .calendar-wrapper { margin-bottom: 40px; overflow-x: auto; }
        .calendar-header {
            display: grid; grid-template-columns: repeat(7, minmax(50px, 1fr));
            background: var(--primary); color: white; padding: 12px 0; text-align: center; font-weight: bold; border-radius: 8px 8px 0 0;
        }
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, minmax(50px, 1fr));
            border: 1px solid #ccc; background: #fff;
        }
        .day-cell {
            min-height: 100px; border-right: 1px solid #eee; border-bottom: 1px solid #eee;
            padding: 8px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;
        }
        .day-cell:hover { background-color: #fdfdfd; box-shadow: inset 0 0 0 2px var(--accent); }
        .day-cell.empty { background: #f8f9fa; cursor: default; }

        /* Clases de Estado */
        .cell-diurno { background-color: var(--day-bg); color: var(--day-text); }
        .cell-nocturno { background-color: var(--night-bg); color: var(--night-text); }
        .cell-descanso { background-color: var(--rest-bg); color: var(--rest-text); }
        .cell-permiso { background-color: var(--perm-bg); color: var(--perm-text); }
        .cell-ausencia { background-color: var(--abs-bg); color: var(--abs-text); }

        .day-number { font-weight: bold; display: flex; justify-content: space-between; }
        .rate-indicator { font-size: 0.6em; background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; }
        .day-label { font-size: 0.75em; text-align: center; font-weight: bold; text-transform: uppercase; }
        .day-money { font-size: 0.85em; text-align: right; font-weight: 700; }

        /* Resultados */
        .financial-summary {
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
            background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 30px; margin-bottom: 40px;
        }
        .section-header { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; color: var(--primary); }
        .stat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #f1f1f1; }
        .stat-row.total { font-weight: bold; font-size: 1.2em; border-top: 2px solid #ddd; margin-top: 15px; padding-top: 15px; }
        .final-pay { grid-column: 1 / -1; background: var(--primary); color: #fff; text-align: center; padding: 25px; border-radius: 10px; }
        .final-pay h2 { margin: 5px 0 0 0; font-size: 2.5em; }

        /* Guía Detallada */
        .education-section { background-color: #fff; border-radius: 12px; padding: 25px; border: 1px solid #e0e0e0; }
        .education-header { text-align: center; margin-bottom: 20px; }
        .education-header h2 { color: var(--info); margin: 0; }
        .formula-box { background: #fff8e1; color: #856404; padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 0.9em; text-align: center; border: 1px solid #ffeeba; }
        
        .rates-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .rate-card { background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; padding: 15px; transition: transform 0.2s;}
        .rate-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color: var(--accent); }
        
        .rate-title { font-weight: bold; color: var(--primary); font-size: 1em; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .rate-percentage { background: var(--info); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        .rate-calc { font-size: 0.85em; color: #666; margin-bottom: 10px; font-style: italic; }
        .rate-value { font-size: 1.3em; font-weight: bold; color: var(--accent); text-align: right; }
        
        @media (max-width: 768px) { .financial-summary { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>Calculadora Vigilantes <span class="badge-new">NOVEDADES</span></h1>
    <p class="subtitle">Incluye Permisos, Ausencias, PDF y Lógica Ley 2101</p>

    <div class="controls-panel">
        <div class="input-group">
            <label>Salario B&aacute;sico ($)</label>
            <input type="number" id="baseSalary" value="1750905" onchange="fullRecalculate()">
        </div>
        <div class="input-group">
            <label>Auxilio Transporte ($)</label>
            <input type="number" id="transportAux" value="249095" onchange="fullRecalculate()">
        </div>
        <div class="input-group">
            <label>Mes a Liquidar</label>
            <input type="month" id="selectedMonth" onchange="resetAndGenerate()">
        </div>
        <div class="input-group">
            <label>Patr&oacute;n</label>
            <select id="shiftPattern">
                <option value="2D2N2X">2x2x2 (Rotativo)</option>
                <option value="4D2X">4x2 Diurno</option>
                <option value="4N2X">4x2 Nocturno</option>
                <option value="MANUAL">Manual</option>
            </select>
        </div>
        <div class="input-group">
            <label>Inicio Ciclo</label>
            <input type="date" id="cycleStartDate">
        </div>
        <div class="btn-group">
            <button class="btn-action" onclick="resetAndGenerate()">Generar Calendario</button>
            <button class="btn-pdf" onclick="generatePDF()">Descargar PDF</button>
        </div>
    </div>

    <div class="calendar-wrapper">
        <div class="calendar-header">
            <div>Dom</div><div>Lun</div><div>Mar</div><div>Mi&eacute;</div><div>Jue</div><div>Vie</div><div>S&aacute;b</div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="financial-summary">
        <div class="col-devengado">
            <div class="section-header">(+) DEVENGADO</div>
            <div class="stat-row"><span>Valor Turnos (Bas + Rec + Ext)</span> <span id="valTotalTurnos">$ 0</span></div>
            <div class="stat-row"><span>Aux. Transporte</span> <span id="valTransporte">$ 0</span></div>
            <div class="stat-row total" style="color: var(--accent);"><span>TOTAL DEVENGADO</span> <span id="totalDevengado">$ 0</span></div>
        </div>
        <div class="col-deducciones">
            <div class="section-header">(-) DEDUCCIONES</div>
            <div class="stat-row"><span>Salud (4%)</span> <span id="dedSalud">$ 0</span></div>
            <div class="stat-row"><span>Pensi&oacute;n (4%)</span> <span id="dedPension">$ 0</span></div>
            <div class="stat-row total" style="color: #c0392b;"><span>TOTAL DEDUCCIONES</span> <span id="totalDeducciones">$ 0</span></div>
        </div>
        <div class="final-pay">
            <small>NETO A PAGAR</small>
            <h2 id="netPay">$ 0</h2>
        </div>
    </div>

    <div class="education-section">
        <div class="education-header">
            <h2>Gu&iacute;a de Tarifas y Novedades</h2>
            <p>Calculado con divisor autom&aacute;tico seg&uacute;n fecha. Hora redondeada.</p>
        </div>

        <div class="formula-box">
            <strong>Valor Hora Actual:</strong> <span id="lblValorHora" style="font-weight: bold; font-size: 1.2em;">---</span>
        </div>

        <div class="rates-grid">
            <div class="rate-card">
                <div class="rate-title">Hora Ordinaria <span class="rate-percentage">1.0x</span></div>
                <div class="rate-calc">Salario / Divisor</div>
                <div class="rate-value" id="rate-ord">$ 0</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">Recargo Nocturno <span class="rate-percentage">0.35x</span></div>
                <div class="rate-calc">Plus (7pm - 6am)</div>
                <div class="rate-value" id="rate-rec-noc">$ 0</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">Extra Diurna <span class="rate-percentage">1.25x</span></div>
                <div class="rate-calc">Hora Base + 25%</div>
                <div class="rate-value" id="rate-ext-diu">$ 0</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">Extra Nocturna <span class="rate-percentage">1.75x</span></div>
                <div class="rate-calc">Hora Base + 75%</div>
                <div class="rate-value" id="rate-ext-noc">$ 0</div>
            </div>
            <div class="rate-card">
                <div class="rate-title">Dominical/Festivo <span class="rate-percentage">1.75x</span></div>
                <div class="rate-calc">Recargo Festivo Ord.</div>
                <div class="rate-value" id="rate-rec-dom">$ 0</div>
            </div>
             <div class="rate-card">
                <div class="rate-title">Permiso Remun. <span class="rate-percentage" style="background:purple;">Pago</span></div>
                <div class="rate-calc">Se paga como día básico</div>
                <div class="rate-value" style="color:purple;">8 Horas</div>
            </div>
             <div class="rate-card">
                <div class="rate-title">Ausencia No Just. <span class="rate-percentage" style="background:red;">$0</span></div>
                <div class="rate-calc">No se paga el día</div>
                <div class="rate-value" style="color:red;">$ 0</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- LÓGICA DE DIVISOR ---
    function getDivisorForDate(year, month, day) {
        const current = new Date(year, month - 1, day).getTime();
        const transition = new Date(2026, 6, 15).getTime(); 
        return (current >= transition) ? 210 : 220;
    }

    // --- CONFIGURACIÓN ---
    const patterns = {
        '2D2N2X': ['D', 'D', 'N', 'N', 'X', 'X'],
        '4D2X': ['D', 'D', 'D', 'D', 'X', 'X'],
        '4N2X': ['N', 'N', 'N', 'N', 'X', 'X'],
        'MANUAL': ['X']
    };

    let dayStates = [];
    // SECUENCIA DE ESTADOS ACTUALIZADA: D -> N -> X -> P -> A -> D
    const nextState = { 'D': 'N', 'N': 'X', 'X': 'P', 'P': 'A', 'A': 'D' };
    
    const stateConfig = {
        'D': { label: 'Diurno', class: 'cell-diurno' },
        'N': { label: 'Nocturno', class: 'cell-nocturno' },
        'X': { label: 'Descanso', class: 'cell-descanso' },
        'P': { label: 'Permiso', class: 'cell-permiso' },
        'A': { label: 'Ausencia', class: 'cell-ausencia' }
    };

    const today = new Date();
    document.getElementById('selectedMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('cycleStartDate').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-01`;

    resetAndGenerate();

    function fullRecalculate() {
        updateEducationalTable();
        recalculate();
        const [year, month] = document.getElementById('selectedMonth').value.split('-').map(Number);
        renderGrid(year, month);
    }

    function resetAndGenerate() {
        const monthInput = document.getElementById('selectedMonth').value;
        const patternKey = document.getElementById('shiftPattern').value;
        const cycleStartInput = document.getElementById('cycleStartDate').value;
        
        if (!monthInput || !cycleStartInput) return;

        const [year, month] = monthInput.split('-').map(Number);
        const cycleStartDate = new Date(cycleStartInput + 'T00:00:00');
        const daysInMonth = new Date(year, month, 0).getDate();
        
        dayStates = new Array(daysInMonth + 1).fill('X');
        const pattern = patterns[patternKey];

        for (let day = 1; day <= daysInMonth; day++) {
            if(patternKey === 'MANUAL') {
                dayStates[day] = 'X'; continue;
            }
            const currentObj = new Date(year, month - 1, day);
            const diffTime = currentObj - cycleStartDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            let patternIndex = diffDays % pattern.length;
            if (patternIndex < 0) patternIndex = pattern.length + patternIndex;
            dayStates[day] = pattern[patternIndex];
        }

        renderGrid(year, month);
        fullRecalculate();
    }

    function renderGrid(year, month) {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const firstDayOfMonth = new Date(year, month - 1, 1);
        const startDayOfWeek = firstDayOfMonth.getDay(); 
        const daysInMonth = dayStates.length - 1;

        for (let i = 0; i < startDayOfWeek; i++) {
            const empty = document.createElement('div');
            empty.className = 'day-cell empty';
            grid.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const state = dayStates[day];
            const cell = document.createElement('div');
            const config = stateConfig[state];
            const divisor = getDivisorForDate(year, month, day);
            const cellVals = calculateDayComponents(state, year, month, day); 

            cell.className = `day-cell ${config.class}`;
            cell.onclick = () => toggleDay(day);

            cell.innerHTML = `
                <div class="day-number">${day} <span class="rate-indicator">${divisor}h</span></div>
                <div class="day-label">${config.label}</div>
                <div class="day-money">$ ${Math.round(cellVals.total).toLocaleString()}</div>
            `;
            grid.appendChild(cell);
        }
    }

    function toggleDay(day) {
        dayStates[day] = nextState[dayStates[day]];
        fullRecalculate();
    }

    // --- CÁLCULO DÍA A DÍA CON NOVEDADES ---
    function calculateDayComponents(type, year, month, day) {
        const salary = parseFloat(document.getElementById('baseSalary').value) || 0;
        const divisor = getDivisorForDate(year, month, day);
        const hourValue = Math.round(salary / divisor);

        let total = 0;
        let details = { basic: 0, recargo: 0, extra: 0 };

        switch(type) {
            case 'X': // Descanso
            case 'P': // Permiso Remunerado
                // Se pagan las 8 horas base del día
                total = 8 * hourValue; 
                details.basic = total;
                break;

            case 'A': // Ausencia No Justificada
                // No se paga nada
                total = 0;
                break;

            case 'D': // Diurno 12h
                const valOrd = 8 * hourValue;
                const valExt = 4 * hourValue * 1.25;
                total = valOrd + valExt;
                details.basic = valOrd;
                details.extra = valExt;
                break;

            case 'N': // Nocturno 12h
                const valOrdDiu = 1 * hourValue;
                const valOrdNoc = 7 * hourValue * 1.35;
                const valExtNoc = 4 * hourValue * 1.75;
                total = valOrdDiu + valOrdNoc + valExtNoc;
                details.basic = valOrdDiu + (7 * hourValue); 
                details.recargo = (7 * hourValue * 0.35);    
                details.extra = valExtNoc;
                break;
        }
        
        return { total, ...details };
    }

    function recalculate() {
        const monthInput = document.getElementById('selectedMonth').value;
        const [year, month] = monthInput.split('-').map(Number);
        
        let grandTotal = 0;

        for (let day = 1; day < dayStates.length; day++) {
            const comps = calculateDayComponents(dayStates[day], year, month, day);
            grandTotal += comps.total;
        }

        const auxTransporte = parseFloat(document.getElementById('transportAux').value) || 0;
        const ibc = grandTotal;
        const salud = Math.round(ibc * 0.04);
        const pension = Math.round(ibc * 0.04);
        const totalDeducciones = salud + pension;
        const neto = (ibc + auxTransporte) - totalDeducciones;

        document.getElementById('valTotalTurnos').innerText = formatMoney(grandTotal);
        document.getElementById('valTransporte').innerText = formatMoney(auxTransporte);
        document.getElementById('totalDevengado').innerText = formatMoney(grandTotal + auxTransporte);
        document.getElementById('dedSalud').innerText = formatMoney(salud);
        document.getElementById('dedPension').innerText = formatMoney(pension);
        document.getElementById('totalDeducciones').innerText = formatMoney(totalDeducciones);
        document.getElementById('netPay').innerText = formatMoney(neto);
    }

    function updateEducationalTable() {
        const salary = parseFloat(document.getElementById('baseSalary').value) || 0;
        const monthInput = document.getElementById('selectedMonth').value;
        const [year, month] = monthInput.split('-').map(Number);
        const divisorRef = getDivisorForDate(year, month, 1);
        const hourVal = Math.round(salary / divisorRef); 

        document.getElementById('lblValorHora').innerText = formatMoney(hourVal) + ` (Base ${divisorRef}h)`;
        document.getElementById('rate-ord').innerText = formatMoney(hourVal);
        document.getElementById('rate-rec-noc').innerText = formatMoney(hourVal * 0.35);
        document.getElementById('rate-ext-diu').innerText = formatMoney(hourVal * 1.25);
        document.getElementById('rate-ext-noc').innerText = formatMoney(hourVal * 1.75);
        document.getElementById('rate-rec-dom').innerText = formatMoney(hourVal * 1.75);
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const monthInput = document.getElementById('selectedMonth').value;
        const [year, month] = monthInput.split('-').map(Number);
        const salary = document.getElementById('baseSalary').value;

        doc.setFontSize(18);
        doc.text("Reporte de N\u00F3mina (Con Novedades)", 105, 15, null, null, "center");
        doc.setFontSize(10);
        doc.text(`Periodo: ${monthInput} | Salario Base: ${formatMoney(salary)}`, 105, 22, null, null, "center");

        const totalTurnos = document.getElementById('valTotalTurnos').innerText;
        const auxTrans = document.getElementById('valTransporte').innerText;
        const totalDev = document.getElementById('totalDevengado').innerText;
        const salud = document.getElementById('dedSalud').innerText;
        const pension = document.getElementById('dedPension').innerText;
        const totalDed = document.getElementById('totalDeducciones').innerText;
        const neto = document.getElementById('netPay').innerText;

        doc.autoTable({
            startY: 30,
            head: [['Concepto', 'Devengados', 'Deducciones']],
            body: [
                ['Valor Turnos Trabajados', totalTurnos, ''],
                ['Auxilio de Transporte', auxTrans, ''],
                ['Aporte Salud (4%)', '', salud],
                ['Aporte Pensi\u00F3n (4%)', '', pension],
                [{content: 'TOTALES', styles: {fontStyle: 'bold'}}, totalDev, totalDed],
                [{content: 'NETO A PAGAR', colSpan: 3, styles: {halign: 'center', fontSize: 14, fillColor: [44, 62, 80], textColor: 255}}, neto, '']
            ],
            theme: 'grid',
            headStyles: { fillColor: [44, 62, 80] },
            columnStyles: { 1: { halign: 'right' }, 2: { halign: 'right' } }
        });

        let rows = [];
        const stateLabels = { 'D': 'Diurno', 'N': 'Nocturno', 'X': 'Descanso', 'P': 'Permiso', 'A': 'Ausencia' };
        
        for (let day = 1; day < dayStates.length; day++) {
            const state = dayStates[day];
            const divisor = getDivisorForDate(year, month, day);
            const comps = calculateDayComponents(state, year, month, day);
            
            rows.push([
                day,
                stateLabels[state],
                divisor, 
                formatMoney(comps.basic),
                formatMoney(comps.recargo),
                formatMoney(comps.extra),
                formatMoney(comps.total)
            ]);
        }

        doc.text("Detalle Diario de Asistencia", 14, doc.lastAutoTable.finalY + 10);

        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 15,
            head: [['Dia', 'Novedad', 'Div', 'Basico', 'Recargos', 'Extras', 'Total']],
            body: rows,
            theme: 'striped',
            headStyles: { fillColor: [39, 174, 96] },
            styles: { fontSize: 8, halign: 'right' },
            columnStyles: { 0: { halign: 'center' }, 1: { halign: 'left' } }
        });

        doc.save(`Nomina_Novedades_${monthInput}.pdf`);
    }

    function formatMoney(num) { 
        if(typeof num === 'string') return num;
        return '$ ' + Math.round(num).toLocaleString('es-CO'); 
    }
</script>

</body>

</html>
